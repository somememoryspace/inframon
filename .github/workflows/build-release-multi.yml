name: Main Branch Build Multi-Arch

on:
  push:
    branches: [ "main" ]

jobs:
  fetch-dev-artifacts:
    runs-on: ubuntu-latest
    outputs:
      dev-artifacts-found: ${{ steps.check-dev-artifacts.outputs.dev-artifacts-found }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest successful dev workflow run
        id: get-dev-run
        run: |
          DEV_RUN_ID=$(gh run list --workflow=build-dev-multi.yml --branch=dev --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
          echo "dev-run-id=$DEV_RUN_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download dev artifacts
        run: |
          if [ -n "${{ steps.get-dev-run.outputs.dev-run-id }}" ]; then
            mkdir -p dev-artifacts
            gh run download ${{ steps.get-dev-run.outputs.dev-run-id }} --dir dev-artifacts
            echo "Dev artifacts downloaded successfully"
          else
            echo "No successful dev workflow run found. Skipping artifact download."
            mkdir -p dev-artifacts
            echo "This is a placeholder file" > dev-artifacts/placeholder.txt
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if dev artifacts exist
        id: check-dev-artifacts
        run: |
          if [ -f "dev-artifacts/inframon-linux-amd64/inframon-linux-amd64" ] && \
             [ -f "dev-artifacts/inframon-linux-arm64/inframon-linux-arm64" ] && \
             [ -f "dev-artifacts/inframon-darwin-arm64/inframon-darwin-arm64" ]; then
            echo "dev-artifacts-found=true" >> $GITHUB_OUTPUT
          else
            echo "dev-artifacts-found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload dev artifacts for main workflow
        uses: actions/upload-artifact@v4
        with:
          name: dev-artifacts
          path: dev-artifacts

  gitleaks-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-go-binary:
    needs: [fetch-dev-artifacts, gitleaks-scan]
    if: needs.fetch-dev-artifacts.outputs.dev-artifacts-found == 'false'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        arch: [amd64, arm64]
        include:
          - os: ubuntu-latest
            goos: linux
          - os: macos-latest
            goos: darwin
        exclude:
          - os: macos-latest
            arch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.5

      - name: Build Go binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -o inframon-${{ matrix.goos }}-${{ matrix.arch }} ./src

      - name: Generate SHA256 checksum
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            sha256sum inframon-${{ matrix.goos }}-${{ matrix.arch }} > inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256
          elif [ "${{ runner.os }}" == "macOS" ]; then
            shasum -a 256 inframon-${{ matrix.goos }}-${{ matrix.arch }} > inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256
          else
            echo "Unsupported OS for SHA256 generation"
            exit 1
          fi
          echo "SHA256 checksum for inframon-${{ matrix.goos }}-${{ matrix.arch }}:"
          cat inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256

      - name: Upload binary and checksum as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: inframon-${{ matrix.goos }}-${{ matrix.arch }}
          path: |
            inframon-${{ matrix.goos }}-${{ matrix.arch }}
            inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256

  validate-checksum:
    needs: [fetch-dev-artifacts, build-go-binary]
    if: needs.fetch-dev-artifacts.outputs.dev-artifacts-found == 'false'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        arch: [amd64, arm64]
        include:
          - os: ubuntu-latest
            goos: linux
          - os: macos-latest
            goos: darwin
        exclude:
          - os: macos-latest
            arch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download binary and checksum
        uses: actions/download-artifact@v4
        with:
          name: inframon-${{ matrix.goos }}-${{ matrix.arch }}

      - name: Validate checksum
        run: |
          echo "Validating checksum for inframon-${{ matrix.goos }}-${{ matrix.arch }}"
          if [ "${{ runner.os }}" == "Linux" ]; then
            sha256sum -c inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256
          elif [ "${{ runner.os }}" == "macOS" ]; then
            shasum -a 256 -c inframon-${{ matrix.goos }}-${{ matrix.arch }}.sha256
          else
            echo "Unsupported OS for SHA256 validation"
            exit 1
          fi

  package-docker-image:
    needs: [fetch-dev-artifacts, validate-checksum]
    if: needs.fetch-dev-artifacts.outputs.dev-artifacts-found == 'false'
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: inframon-linux-${{ matrix.arch }}

      - name: Build Docker image
        run: |
          docker buildx build --platform linux/${{ matrix.arch }} \
            -t inframon:latest-${{ matrix.arch }} \
            --build-arg BINARY=inframon-linux-${{ matrix.arch }} \
            --load .

      - name: Save Docker image
        run: |
          docker save inframon:latest-${{ matrix.arch }} > inframon-latest-${{ matrix.arch }}.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.arch }}
          path: inframon-latest-${{ matrix.arch }}.tar

  security-scan:
    needs: [fetch-dev-artifacts, package-docker-image]
    if: needs.fetch-dev-artifacts.outputs.dev-artifacts-found == 'false'
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.arch }}

      - name: Load Docker image
        run: |
          docker load < inframon-latest-${{ matrix.arch }}.tar

      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Run Trivy vulnerability scanner
        run: |
          mkdir -p scan_results
          trivy image --exit-code 1 --severity HIGH,CRITICAL --format table \
            --output scan_results/trivy-results-${{ matrix.arch }}.txt \
            inframon:latest-${{ matrix.arch }}

      - name: Generate SBOM
        run: |
          mkdir -p sbom_reports
          trivy image --format json \
            --output sbom_reports/sbom-${{ matrix.arch }}.json \
            inframon:latest-${{ matrix.arch }}

      - name: Upload scan results and SBOM
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-${{ matrix.arch }}
          path: |
            scan_results/trivy-results-${{ matrix.arch }}.txt
            sbom_reports/sbom-${{ matrix.arch }}.json

  push-images:
    needs: [fetch-dev-artifacts, security-scan]
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Set lowercase repository name
        run: |
          echo "GITHUB_REPOSITORY_LOWERCASE=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.fetch-dev-artifacts.outputs.dev-artifacts-found == 'true' && 'dev-artifacts' || 'docker-image-${{ matrix.arch }}' }}

      - name: Load Docker image
        run: |
          if [ "${{ needs.fetch-dev-artifacts.outputs.dev-artifacts-found }}" == "true" ]; then
            docker load < dev-artifacts/docker-image-${{ matrix.arch }}/inframon-dev-${{ matrix.arch }}.tar
          else
            docker load < inframon-latest-${{ matrix.arch }}.tar
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_CR }}

      - name: Tag and push Docker image
        run: |
          if [ "${{ needs.fetch-dev-artifacts.outputs.dev-artifacts-found }}" == "true" ]; then
            docker tag inframon:dev-${{ matrix.arch }} ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest-${{ matrix.arch }}
          else
            docker tag inframon:latest-${{ matrix.arch }} ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest-${{ matrix.arch }}
          fi
          docker push ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest-${{ matrix.arch }}

  create-multiarch-manifest:
    needs: push-images
    runs-on: ubuntu-latest
    steps:
      - name: Set lowercase repository name
        run: |
          echo "GITHUB_REPOSITORY_LOWERCASE=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_CR }}

      - name: Create and push multi-arch manifest
        run: |
          docker manifest create ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest \
            ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest-amd64 \
            ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest-arm64

          docker manifest push ghcr.io/${{ env.GITHUB_REPOSITORY_LOWERCASE }}/inframon:latest

  create-release:
    needs: [fetch-dev-artifacts, create-multiarch-manifest, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release tag
        run: |
          echo "RELEASE_TAG=v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare artifact paths
        run: |
          if [ "${{ needs.fetch-dev-artifacts.outputs.dev-artifacts-found }}" == "true" ]; then
            echo "LINUX_AMD64_PATH=all-artifacts/dev-artifacts/inframon-linux-amd64/inframon-linux-amd64" >> $GITHUB_ENV
            echo "LINUX_ARM64_PATH=all-artifacts/dev-artifacts/inframon-linux-arm64/inframon-linux-arm64" >> $GITHUB_ENV
            echo "DARWIN_ARM64_PATH=all-artifacts/dev-artifacts/inframon-darwin-arm64/inframon-darwin-arm64" >> $GITHUB_ENV
          else
            echo "LINUX_AMD64_PATH=all-artifacts/inframon-linux-amd64/inframon-linux-amd64" >> $GITHUB_ENV
            echo "LINUX_ARM64_PATH=all-artifacts/inframon-linux-arm64/inframon-linux-arm64" >> $GITHUB_ENV
            echo "DARWIN_ARM64_PATH=all-artifacts/inframon-darwin-arm64/inframon-darwin-arm64" >> $GITHUB_ENV
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: |
            Release of version ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          files: |
            ${{ env.LINUX_AMD64_PATH }}
            ${{ env.LINUX_AMD64_PATH }}.sha256
            ${{ env.LINUX_ARM64_PATH }}
            ${{ env.LINUX_ARM64_PATH }}.sha256
            ${{ env.DARWIN_ARM64_PATH }}
            ${{ env.DARWIN_ARM64_PATH }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check release creation
        if: failure()
        run: |
          echo "Release creation failed. Please check your permissions and file paths."
          echo "Available files in all-artifacts directory:"
          ls -R all-artifacts